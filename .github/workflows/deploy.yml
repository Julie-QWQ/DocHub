name: Auto Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH to server and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # 遇到错误立即退出

            # 设置 Git 超时时间和重试
            git config --global http.lowSpeedLimit 0
            git config --global http.lowSpeedTime 999999
            git config --global http.postBuffer 1048576000

            echo "=== 1. 拉取最新代码 ==="
            cd /root/upc-study

            # 尝试使用 GitHub 镜像加速（如果原生 GitHub 很慢）
            CURRENT_REMOTE=$(git remote get-url origin)
            if [[ ! "$CURRENT_REMOTE" =~ "github.com.cnpmjs.org" ]] && [[ ! "$CURRENT_REMOTE" =~ "ghproxy.com" ]]; then
              echo "检测到使用原生 GitHub 地址，切换到镜像加速..."
              ORIGINAL_REMOTE="$CURRENT_REMOTE"
              # 提取仓库路径，如: username/repo.git
              REPO_PATH=$(echo "$CURRENT_REMOTE" | sed -E 's|https://github.com/||')
              # 使用 cnpmjs 镜像
              git remote set-url origin "https://github.com.cnpmjs.org/$REPO_PATH"
            fi

            # 使用 git fetch + git reset 更可靠
            git fetch --all
            git reset --hard origin/main

            # 恢复原始远程地址（可选，如果不需要可以注释掉）
            # if [ -n "$ORIGINAL_REMOTE" ]; then
            #   git remote set-url origin "$ORIGINAL_REMOTE"
            # fi

            echo "=== 2. 安装前端依赖 ==="
            cd /root/upc-study/frontend

            # 使用国内 npm 镜像加速
            npm config set registry https://registry.npmmirror.com
            npm ci

            echo "=== 3. 构建前端 ==="
            npm run build
            if [ ! -d "dist" ]; then
              echo "❌ 前端构建失败：dist 目录不存在"
              exit 1
            fi

            echo "=== 4. 部署前端文件 ==="
            rm -rf /var/www/upc-study
            cp -r dist /var/www/upc-study

            echo "=== 5. 重启 Nginx ==="
            sudo systemctl restart nginx
            sudo systemctl status nginx --no-pager

            echo "=== 6. 下载 Go 依赖 ==="
            cd /root/upc-study/backend

            # 使用国内 Go 代理加速
            export GOPROXY=https://goproxy.cn,direct
            go mod download

            echo "=== 7. 构建后端 ==="
            go build -o upc-study-server cmd/server/main.go
            if [ ! -f "upc-study-server" ]; then
              echo "❌ 后端构建失败：可执行文件不存在"
              exit 1
            fi

            echo "=== 8. 部署后端服务 ==="
            sudo chmod +x upc-study-server

            echo "=== 9. 重启后端服务 ==="
            sudo systemctl restart upc-study
            sudo systemctl status upc-study --no-pager

            echo "✅ 部署完成！"
